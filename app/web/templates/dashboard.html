<!-- app/web/templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Дашборд - Мониторинг вакансий{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-dashboard"></i> Дашборд системы</h1>
        <p class="lead">Статистика и аналитика по вакансиям HeadHunter</p>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle"></i> Ошибка при загрузке данных: {{ error }}
</div>
{% endif %}

<!-- Статистические карточки -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body text-center">
                <h1 class="display-4">{{ total_vacancies|default(0) }}</h1>
                <p class="card-text">Всего вакансий</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body text-center">
                <h1 class="display-4">{{ total_companies|default(0) }}</h1>
                <p class="card-text">Компаний</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body text-center">
                <h1 class="display-4">{{ total_regions|default(0) }}</h1>
                <p class="card-text">Регионов</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body text-center">
                <h1 class="display-4">
                    {% if average_salary %}
                        {{ "%.0f"|format(average_salary) }}₽
                    {% else %}
                        -
                    {% endif %}
                </h1>
                <p class="card-text">Средняя зарплата</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Распределение по ролям -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Распределение вакансий по бизнес-ролям</h5>
            </div>
            <div class="card-body">
                {% if stats and stats.vacancies_by_role %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Роль</th>
                                    <th class="text-end">Количество</th>
                                    <th class="text-end">%</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stats.vacancies_by_role %}
                                <tr>
                                    <td>{{ item.role }}</td>
                                    <td class="text-end">{{ item.count }}</td>
                                    <td class="text-end">
                                        {% if total_vacancies > 0 %}
                                            {{ "%.1f"|format(item.count / total_vacancies * 100) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Нет данных о распределении по ролям</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Топ компаний -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-building"></i> Топ компаний по вакансиям</h5>
            </div>
            <div class="card-body">
                {% if stats and stats.top_companies %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Компания</th>
                                    <th class="text-end">Вакансий</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stats.top_companies %}
                                <tr>
                                    <td>{{ item.company }}</td>
                                    <td class="text-end">{{ item.vacancy_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Нет данных о компаниях</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Топ регионов -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map-marker-alt"></i> Топ регионов по вакансиям</h5>
            </div>
            <div class="card-body">
                {% if stats and stats.top_regions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Регион</th>
                                    <th class="text-end">Вакансий</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in stats.top_regions %}
                                <tr>
                                    <td>{{ item.region }}</td>
                                    <td class="text-end">{{ item.vacancy_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">Нет данных о регионах</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Информация о зарплатах -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-money-bill-wave"></i> Информация о зарплатах</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <p>
                            <i class="fas fa-chart-bar text-primary"></i>
                            Вакансий с указанием зарплаты:
                            <strong>{{ stats.total_with_salary|default(0) }}</strong>
                            из {{ total_vacancies|default(0) }}
                        </p>
                        <div class="progress mb-3">
                            {% if total_vacancies > 0 %}
                                {% set salary_percent = (stats.total_with_salary / total_vacancies * 100)|round|int %}
                            {% else %}
                                {% set salary_percent = 0 %}
                            {% endif %}
                            <div class="progress-bar bg-success" style="width:  salary_percent ">
                                {{ salary_percent }}%
                            </div>
                        </div>
                    </div>
                </div>
                {% if average_salary %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Средняя зарплата по всем вакансиям: 
                    <strong>{{ "%.0f"|format(average_salary) }} рублей</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- График динамики вакансий -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Динамика вакансий (последние 30 дней)</h5>
            </div>
            <div class="card-body">
                <canvas id="vacancyChart" style="width:100%; max-height:400px;"></canvas>
                <div id="chartNoData" class="text-center text-muted" style="display: none;">
                    <i class="fas fa-chart-bar fa-3x"></i><br>
                    Нет данных для отображения
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
$(document).ready(function() {
    // Загрузка данных для графика
    $.get('/api/vacancy_dynamics?days=30')
        .done(function(data) {
            if (data.error) {
                $('#chartNoData').show();
                return;
            }
            if (!data || data.length === 0) {
                $('#chartNoData').show();
                return;
            }

            const labels = data.map(item => item.date);
            const counts = data.map(item => item.count);

            const ctx = document.getElementById('vacancyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Количество вакансий',
                        data: counts,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            title: { display: true, text: 'Дата' },
                            ticks: { maxRotation: 45, minRotation: 45 }
                        },
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Количество вакансий' }
                        }
                    }
                }
            });
        })
        .fail(function() {
            $('#chartNoData').show();
        });
});
</script>
{% endblock %}